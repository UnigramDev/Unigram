<Page
    x:Class="Unigram.Views.DialogPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:Unigram.Controls"
    xmlns:local="using:Unigram.Views"
    xmlns:messages="using:Unigram.Controls.Messages"
    xmlns:selectors="using:Unigram.Selectors"
    xmlns:viewmodels="using:Unigram.ViewModels"
    xmlns:vm="using:Unigram.ViewModels"
    xmlns:vmc="using:Telegram.Api.TL"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Page.Transitions>
        <TransitionCollection>
            <NavigationThemeTransition>
                <ContinuumNavigationTransitionInfo />
            </NavigationThemeTransition>
        </TransitionCollection>
    </Page.Transitions>

    <Page.Resources>
        <CollectionViewSource x:Name="MessagesSource" IsSourceGrouped="True" Source="{Binding Messages.Groups}"/>

        <Style TargetType="ListViewHeaderItem">
            <Setter Property="FontFamily" Value="{ThemeResource ContentControlThemeFontFamily}" />
            <Setter Property="FontSize" Value="{ThemeResource ListViewHeaderItemThemeFontSize}" />
            <Setter Property="Background" Value="Red" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
            <Setter Property="VerticalContentAlignment" Value="Top" />
            <Setter Property="MinHeight" Value="{ThemeResource ListViewHeaderItemMinHeight}" />
            <Setter Property="UseSystemFocusVisuals" Value="True" />
            <Setter Property="VerticalAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewHeaderItem">
                        <ContentPresenter x:Name="ContentPresenter"
                            Margin="{TemplateBinding Padding}"
                            Content="{TemplateBinding Content}"
                            ContentTemplate="{TemplateBinding ContentTemplate}"
                            ContentTransitions="{TemplateBinding ContentTransitions}"
                            HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                            VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Region Service -->
        <DataTemplate x:Key="ServiceMessageTemplate">
            <StackPanel Margin="0,12">
                <!--<Border Background="#7f89a0b4" HorizontalAlignment="Center" Padding="12,5,12,6">
                     <RichTextBlock common:ServiceHelper.Message="{Binding}" Foreground="White" TextAlignment="Center" Style="{ThemeResource BodyRichTextBlockStyle}"/>
                     </Border>
                     
                     <Border Visibility="{Binding Action.Photo, Converter={StaticResource ExistsToVisibilityConverter}}" Width="96" Height="96" Margin="0,8,0,0">
                     <controls:ImageControl TelegramSource="{Binding Action.Photo}" Stretch="UniformToFill"/>
                     </Border>-->
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="UnreadMessageTemplate">
            <Border Background="#7f89a0b4" HorizontalAlignment="Center" Padding="12,5,12,6" Margin="0,12" RenderTransformOrigin="0.5,0.5">
                <!--<TextBlock Text="{Binding Converter={StaticResource ServiceMessageToTextConverter}}" Foreground="White" Style="{ThemeResource BodyTextBlockStyle}"/>-->
            </Border>
        </DataTemplate>
        <!-- EndRegion -->

        <DataTemplate x:Key="UserMessageTemplate" x:DataType="vmc:TLMessage">
            <messages:UserMessageControl/>
        </DataTemplate>

        <DataTemplate x:Key="FriendMessageTemplate">
            <messages:FriendMessageControl/>
        </DataTemplate>

        <DataTemplate x:Key="ChatFriendMessageTemplate">
            <messages:ChatFriendMessageControl/>
        </DataTemplate>

        <selectors:MessageTemplateSelector x:Key="MessageTemplateSelector"
                                           UserMessageTemplate="{StaticResource UserMessageTemplate}"
                                           UserStickerTemplate="{StaticResource UserStickerTemplate}"
                                           FriendMessageTemplate="{StaticResource FriendMessageTemplate}"
                                           FriendStickerTemplate="{StaticResource FriendStickerTemplate}"
                                           ChatFriendMessageTemplate="{StaticResource ChatFriendMessageTemplate}"
                                           ChatFriendStickerTemplate="{StaticResource ChatFriendStickerTemplate}"
                                           ServiceMessageTemplate="{StaticResource ServiceMessageTemplate}"
                                           UnreadMessagesTemplate="{StaticResource UnreadMessageTemplate}"/>
    </Page.Resources>

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="48" />
            <RowDefinition />
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Titlebar -->
        <Button x:Name="btnDialogInfo"
                Background="{ThemeResource TelegramBackgroundTitlebarBrush}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Padding="0"
                Grid.Row="0" Click="btnDialogInfo_Click">
            <Button.Content>
                <StackPanel Orientation="Horizontal">
                    <!--User icon-->
                    <Ellipse x:Name="elpDialogIcon"
                             Width="40"
                             Height="40"
                             Margin="12,0">
                        <Ellipse.Fill>
                            <ImageBrush ImageSource="ms-appx:///Assets/Mockups/UserIcons/user_batman.png" />
                        </Ellipse.Fill>
                    </Ellipse>
                    <StackPanel Orientation="Vertical"
                                VerticalAlignment="Center">
                        <TextBlock x:Name="tblDialogName"
                                   Text="{x:Bind Path=ViewModel.DialogTitle}"
                                   FontSize="16"
                                   Style="{StaticResource BaseTextBlockStyle}"/>
                        <TextBlock x:Name="tblDialogStatus"
                                   Visibility="Collapsed"
                                   Foreground="{StaticResource SystemControlForegroundBaseMediumBrush}"
                                   FontSize="12"
                                   Text="Online" />
                    </StackPanel>
                </StackPanel>
            </Button.Content>
        </Button>
        <!-- END OF Titlebar -->
        
        <!-- Main content -->
        <RelativePanel Grid.Row="1">
            <Grid RelativePanel.AlignLeftWithPanel="True"
                  RelativePanel.AlignRightWithPanel="True"
                  RelativePanel.AlignTopWithPanel="True"
                  RelativePanel.Above="rpInput">
                <Image Source="ms-appx:///Assets/Images/DefaultBackground.jpg" Stretch="UniformToFill"/>
                <controls:BubbleListView x:Name="lvDialogs" 
                                         ItemsSource="{Binding Source={StaticResource MessagesSource}}"
                                         ItemTemplateSelector="{StaticResource MessageTemplateSelector}"
                                         SelectionMode="None">
                    <ListView.ItemsPanel>
                        <ItemsPanelTemplate>
                            <ItemsStackPanel GroupHeaderPlacement="Left"
                                             ItemsUpdatingScrollMode="KeepLastItemInView"
                                             VerticalAlignment="Bottom" />
                        </ItemsPanelTemplate>
                    </ListView.ItemsPanel>
                    <ListView.ItemContainerStyleSelector>
                        <selectors:MessageStyleSelector>
                            <selectors:MessageStyleSelector.MessageStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="FontFamily" Value="{ThemeResource ContentControlThemeFontFamily}" />
                                    <Setter Property="FontSize" Value="{ThemeResource ControlContentThemeFontSize}" />
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Foreground" Value="{ThemeResource SystemControlForegroundBaseHighBrush}" />
                                    <Setter Property="TabNavigation" Value="Local"/>
                                    <Setter Property="IsHoldingEnabled" Value="True"/>
                                    <Setter Property="Padding" Value="12,0,12,0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Setter Property="MinWidth" Value="{ThemeResource ListViewItemMinWidth}"/>
                                    <Setter Property="MinHeight" Value="0"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListViewItem">
                                                <ListViewItemPresenter
                                                    ContentTransitions="{TemplateBinding ContentTransitions}"
                                                    SelectionCheckMarkVisualEnabled="True"
                                                    CheckBrush="{ThemeResource SystemControlForegroundBaseMediumHighBrush}"
                                                    CheckBoxBrush="{ThemeResource SystemControlForegroundBaseMediumHighBrush}"
                                                    DragBackground="{ThemeResource ListViewItemDragBackgroundThemeBrush}"
                                                    DragForeground="{ThemeResource ListViewItemDragForegroundThemeBrush}"
                                                    FocusBorderBrush="{ThemeResource SystemControlForegroundAltHighBrush}"
                                                    FocusSecondaryBorderBrush="{ThemeResource SystemControlForegroundBaseHighBrush}"
                                                    PlaceholderBackground="{ThemeResource ListViewItemPlaceholderBackgroundThemeBrush}"
                                                    PointerOverBackground="Transparent"
                                                    PointerOverForeground="{ThemeResource SystemControlHighlightAltBaseHighBrush}"
                                                    SelectedBackground="{ThemeResource SystemControlHighlightListAccentLowBrush}"
                                                    SelectedForeground="{ThemeResource SystemControlHighlightAltBaseHighBrush}"
                                                    SelectedPointerOverBackground="{ThemeResource SystemControlHighlightListAccentMediumBrush}"
                                                    PressedBackground="Transparent"
                                                    SelectedPressedBackground="{ThemeResource SystemControlHighlightListAccentHighBrush}"
                                                    DisabledOpacity="{ThemeResource ListViewItemDisabledThemeOpacity}"
                                                    DragOpacity="{ThemeResource ListViewItemDragThemeOpacity}"
                                                    ReorderHintOffset="{ThemeResource ListViewItemReorderHintThemeOffset}"
                                                    HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                    VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                                    ContentMargin="{TemplateBinding Padding}"
                                                    CheckMode="Inline"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </selectors:MessageStyleSelector.MessageStyle>
                            <selectors:MessageStyleSelector.ServiceStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="FontFamily" Value="{ThemeResource ContentControlThemeFontFamily}" />
                                    <Setter Property="FontSize" Value="{ThemeResource ControlContentThemeFontSize}" />
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Foreground" Value="{ThemeResource SystemControlForegroundBaseHighBrush}" />
                                    <Setter Property="TabNavigation" Value="Local"/>
                                    <Setter Property="IsHoldingEnabled" Value="True"/>
                                    <Setter Property="Padding" Value="12,0,12,0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Setter Property="MinWidth" Value="{ThemeResource ListViewItemMinWidth}"/>
                                    <Setter Property="MinHeight" Value="0"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListViewItem">
                                                <ListViewItemPresenter
                                                    ContentTransitions="{TemplateBinding ContentTransitions}"
                                                    SelectionCheckMarkVisualEnabled="False"
                                                    CheckBrush="{ThemeResource SystemControlForegroundBaseMediumHighBrush}"
                                                    CheckBoxBrush="{ThemeResource SystemControlForegroundBaseMediumHighBrush}"
                                                    DragBackground="{ThemeResource ListViewItemDragBackgroundThemeBrush}"
                                                    DragForeground="{ThemeResource ListViewItemDragForegroundThemeBrush}"
                                                    FocusBorderBrush="{ThemeResource SystemControlForegroundAltHighBrush}"
                                                    FocusSecondaryBorderBrush="{ThemeResource SystemControlForegroundBaseHighBrush}"
                                                    PlaceholderBackground="{ThemeResource ListViewItemPlaceholderBackgroundThemeBrush}"
                                                    PointerOverBackground="Transparent"
                                                    PointerOverForeground="{ThemeResource SystemControlHighlightAltBaseHighBrush}"
                                                    SelectedBackground="Transparent"
                                                    SelectedForeground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                                                    SelectedPointerOverBackground="{ThemeResource SystemControlHighlightListLowBrush}"
                                                    PressedBackground="Transparent"
                                                    SelectedPressedBackground="{ThemeResource SystemControlHighlightListMediumBrush}"
                                                    DisabledOpacity="{ThemeResource ListViewItemDisabledThemeOpacity}"
                                                    DragOpacity="{ThemeResource ListViewItemDragThemeOpacity}"
                                                    ReorderHintOffset="{ThemeResource ListViewItemReorderHintThemeOffset}"
                                                    HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                    VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                                    ContentMargin="{TemplateBinding Padding}"
                                                    CheckMode="Inline"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </selectors:MessageStyleSelector.ServiceStyle>
                        </selectors:MessageStyleSelector>
                    </ListView.ItemContainerStyleSelector>
                    <ListView.Header>
                        <Border Height="6"/>
                    </ListView.Header>
                    <ListView.Footer>
                        <Border Height="6"/>
                    </ListView.Footer>
                    <ListView.GroupStyle>
                        <GroupStyle>
                            <GroupStyle.HeaderTemplateSelector>
                                <selectors:MessageGroupTemplateSelector>
                                    <selectors:MessageGroupTemplateSelector.ChatFriendMessageTemplate>
                                        <DataTemplate x:DataType="viewmodels:MessageGroup">
                                            <Grid>
                                                <Ellipse Width="32" Height="32" Fill="Red" Margin="12,12,0,0"/>
                                                <Border CornerRadius="32" Width="32" Height="32" Margin="12,12,0,0">
                                                    <Border.Background>
                                                        <ImageBrush ImageSource="{x:Bind From.Photo, Converter={StaticResource DefaultPhotoConverter}, Mode=OneWay}"/>
                                                    </Border.Background>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </selectors:MessageGroupTemplateSelector.ChatFriendMessageTemplate>
                                </selectors:MessageGroupTemplateSelector>
                            </GroupStyle.HeaderTemplateSelector>
                        </GroupStyle>
                    </ListView.GroupStyle>
                </controls:BubbleListView>
            </Grid>
            
            <!-- Input pane -->
            <RelativePanel x:Name="rpInput"
                           MinHeight="{ThemeResource AppBarThemeCompactHeight}"
                           BorderThickness="0,2,0,0"
                           BorderBrush="{ThemeResource TelegramBackgroundAccentBrush}"
                           Visibility="Visible"
                           RelativePanel.AlignLeftWithPanel="True"
                           RelativePanel.AlignRightWithPanel="True"
                           RelativePanel.AlignBottomWithPanel="True">
                <!-- Image thumbnail -->
                <Button x:Name="btnRemoveSingleImgThumbnail"
                        Visibility="Collapsed"
                        Content="&#xE106;"
                        Height="36"
                        Width="36"
                        FontFamily="Segoe MDL2 Assets"
                        RequestedTheme="Dark"
                        Canvas.ZIndex="10"
                        RelativePanel.AlignLeftWithPanel="True"
                        RelativePanel.AlignTopWithPanel="True"/>
                <Image x:Name="imgSingleImgThumbnail" 
                       Visibility="Collapsed"
                       Source="ms-appx:///Assets/Mockups/Images/userPhoto.jpg"
                       Margin="0,0,48,0"
                       RelativePanel.AlignTopWithPanel="True"
                       RelativePanel.AlignLeftWithPanel="True"
                       RelativePanel.AlignRightWithPanel="True"/>
                <!-- Message input -->
                <TextBox x:Name="txtMessage" 
                         x:Uid="Chat-Input-Message"
                         PlaceholderText="Type your message..."
                         Text="{Binding SendTextHolder, Mode=TwoWay}"
                         BorderThickness="0" 
                         Padding="14" 
                         TextWrapping="Wrap" 
                         InputScope="Text" 
                         IsSpellCheckEnabled="True"
                         VerticalAlignment="Bottom" 
                         VerticalContentAlignment="Bottom"
                         MinHeight="48"
                         MaxHeight="84"
                         AcceptsReturn="True"
                         TextChanging="txtMessage_TextChanging"
                         RelativePanel.AlignLeftWithPanel="True"
                         RelativePanel.AlignBottomWithPanel="True"
                         RelativePanel.LeftOf="btnSendMessage" />
                <!-- Send-button -->
                <Button x:Name="btnSendMessage"  
                        Visibility="Visible"
                        IsEnabled="True"
                        Width="48"
                        Command="{Binding SendCommand}"
                        MinHeight="48" 
                        Background="{ThemeResource TelegramBackgroundAccentBrush}"                                      
                        VerticalAlignment="Stretch"
                        ScrollViewer.VerticalScrollBarVisibility="Disabled"
                        RelativePanel.AlignTopWithPanel="True"
                        RelativePanel.AlignBottomWithPanel="True"
                        RelativePanel.AlignRightWithPanel="True" 
                        Click="btnSendMessage_Click">
                    <Button.Content>
                        <TextBlock FontFamily="Segoe MDL2 Assets" 
                                   FontSize="20"
                                   Text="&#xE122;"
                                   RequestedTheme="Dark"/>
                    </Button.Content>
                </Button>

                <!-- Voice Record-button -->
                <Button x:Name="btnVoiceMessage"
                        Visibility="Collapsed"
                        Width="48"
                        MinHeight="48" 
                        Background="Transparent"                                      
                        VerticalAlignment="Stretch"
                        ScrollViewer.VerticalScrollBarVisibility="Disabled"
                        RelativePanel.AlignTopWithPanel="True"
                        RelativePanel.AlignBottomWithPanel="True"                        
                        RelativePanel.AlignRightWithPanel="True" 
                        Click="btnVoiceMessage_Click">
                    <Button.Content>
                        <TextBlock FontFamily="Segoe MDL2 Assets" 
                                   FontSize="20"
                                   Text="&#xE720;"
                                   RequestedTheme="Dark"/>
                    </Button.Content>
                </Button>
            </RelativePanel>
        </RelativePanel>
        <!-- END OF Main content -->        
        
        <!-- Commandbar -->
        <CommandBar x:Name="commandbar"
                    Grid.Row="2">
            <!-- Primary commands (visible in bar) -->
            <CommandBar.PrimaryCommands>
                <AppBarButton x:Name="cbtnAttachment"
                              x:Uid="CBTN-Attachment"
                              Icon="Attach"
                              Label="Attachment">
                    <!-- Attachment options -->
                    <AppBarButton.Flyout>
                        <MenuFlyout>
                            <!-- Please try to add camera capabilities with the W10 file picker first
                                 if that's not possible for all platforms, then enable the Camera-button here and 
                                 write something for that -->
                            <MenuFlyoutItem x:Name="fcbtnAttachCamera"
                                            x:Uid="FCBTN-Camera"
                                            Text="Camera" />
                            <MenuFlyoutItem x:Name="fcbtnAttachPhoto"
                                            x:Uid="FCBTN-Photo"
                                            Text="Photo" 
                                            MinWidth="180"/>
                            <MenuFlyoutItem x:Name="fcbtnAttachVideo"
                                            x:Uid="FCBTN-Video"
                                            Text="Video" />
                            <MenuFlyoutItem x:Name="fcbtnAttachLocation"
                                            x:Uid="FCBTN-Location"
                                            Text="Location" />
                            <MenuFlyoutItem x:Name="fcbtnAttachFile"
                                            x:Uid="FCBTN-File"
                                            Text="File" />
                            <MenuFlyoutItem x:Name="fcbtnAttachContact"
                                            x:Uid="FCBTN-Contact"
                                            Text="Contact" />
                        </MenuFlyout>
                    </AppBarButton.Flyout>
                </AppBarButton>
                <AppBarButton x:Name="cbtnStickers"
                              x:Uid="CBTN-Stickers"
                              Label="Stickers">
                    <AppBarButton.Icon>
                        <FontIcon Glyph="&#xE606;" FontFamily="{ThemeResource TelegramThemeFontFamily}"/>
                    </AppBarButton.Icon>
                    <FlyoutBase.AttachedFlyout>
                        <Flyout>
                            <Grid Height="240"
                                  Width="264">
                                <TextBlock Text="Soon..."
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Grid>
                        </Flyout>
                    </FlyoutBase.AttachedFlyout>
                </AppBarButton>
            </CommandBar.PrimaryCommands>

            <!-- Secondary Commands (hidden in sub menu) -->
            <CommandBar.SecondaryCommands>
                <AppBarButton x:Name="cbtnReportSpam"
                              x:Uid="CBTN-ReportSpam"
                              Icon="ReportHacked"
                              Label="Report spam" />
                <AppBarButton x:Name="cbtnSearch"
                              x:Uid="CBTN-Search"
                              Icon="Find"
                              Label="Search" />
                <AppBarButton x:Name="cbtnPinToStart"
                              x:Uid="CBTN-Pin"
                              Icon="Pin"
                              Label="Pin to Start"/>
            </CommandBar.SecondaryCommands>
        </CommandBar>
        <!-- END OF - Commandbar -->

    </Grid>
</Page>
