<controls:UserControlEx x:Class="Telegram.Views.ChatView"
                        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                        xmlns:icons="using:Telegram.Assets.Icons"
                        xmlns:common="using:Telegram.Common"
                        xmlns:controls="using:Telegram.Controls"
                        xmlns:chats="using:Telegram.Controls.Chats"
                        xmlns:messages="using:Telegram.Controls.Messages"
                        xmlns:local="using:Telegram.Views"
                        mc:Ignorable="d"
                        Connected="OnLoaded"
                        Disconnected="OnUnloaded"
                        SizeChanged="OnSizeChanged">

    <!--<Page.Transitions>
        <TransitionCollection>
            <NavigationThemeTransition>
                <SuppressNavigationTransitionInfo />
            </NavigationThemeTransition>
        </TransitionCollection>
    </Page.Transitions>-->

    <UserControl.Resources>
        <x:Double x:Key="MenuFlyoutMaxWidth">360</x:Double>

        <Style x:Key="HeaderBackgroundStyle"
               TargetType="Border">
            <Setter Property="Background"
                    Value="{ThemeResource PageSubHeaderBackgroundBrush2}" />
        </Style>

        <Style x:Key="AutocompleteListViewStyle"
               TargetType="ListView">
            <Setter Property="IsTabStop"
                    Value="False" />
            <Setter Property="TabNavigation"
                    Value="Once" />
            <Setter Property="IsSwipeEnabled"
                    Value="True" />
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility"
                    Value="Disabled" />
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility"
                    Value="Auto" />
            <Setter Property="ScrollViewer.HorizontalScrollMode"
                    Value="Disabled" />
            <Setter Property="ScrollViewer.IsHorizontalRailEnabled"
                    Value="False" />
            <Setter Property="ScrollViewer.VerticalScrollMode"
                    Value="Enabled" />
            <Setter Property="ScrollViewer.IsVerticalRailEnabled"
                    Value="True" />
            <Setter Property="ScrollViewer.ZoomMode"
                    Value="Disabled" />
            <Setter Property="ScrollViewer.IsDeferredScrollingEnabled"
                    Value="False" />
            <Setter Property="ScrollViewer.BringIntoViewOnFocusChange"
                    Value="True" />
            <Setter Property="UseSystemFocusVisuals"
                    Value="True" />
            <Setter Property="ItemContainerTransitions">
                <Setter.Value>
                    <TransitionCollection>
                        <AddDeleteThemeTransition />
                        <ContentThemeTransition />
                        <ReorderThemeTransition />
                        <!-- TODO: WinUI 3
                        <EntranceThemeTransition IsStaggeringEnabled="False" />-->
                    </TransitionCollection>
                </Setter.Value>
            </Setter>
            <Setter Property="ItemsPanel">
                <Setter.Value>
                    <ItemsPanelTemplate>
                        <ItemsStackPanel Orientation="Vertical" />
                    </ItemsPanelTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListView">
                        <ScrollViewer x:Name="ScrollViewer"
                                      TabNavigation="{TemplateBinding TabNavigation}"
                                      HorizontalScrollMode="{TemplateBinding ScrollViewer.HorizontalScrollMode}"
                                      HorizontalScrollBarVisibility="{TemplateBinding ScrollViewer.HorizontalScrollBarVisibility}"
                                      IsHorizontalScrollChainingEnabled="{TemplateBinding ScrollViewer.IsHorizontalScrollChainingEnabled}"
                                      VerticalScrollMode="{TemplateBinding ScrollViewer.VerticalScrollMode}"
                                      VerticalScrollBarVisibility="{TemplateBinding ScrollViewer.VerticalScrollBarVisibility}"
                                      IsVerticalScrollChainingEnabled="{TemplateBinding ScrollViewer.IsVerticalScrollChainingEnabled}"
                                      IsHorizontalRailEnabled="{TemplateBinding ScrollViewer.IsHorizontalRailEnabled}"
                                      IsVerticalRailEnabled="{TemplateBinding ScrollViewer.IsVerticalRailEnabled}"
                                      ZoomMode="{TemplateBinding ScrollViewer.ZoomMode}"
                                      IsDeferredScrollingEnabled="{TemplateBinding ScrollViewer.IsDeferredScrollingEnabled}"
                                      BringIntoViewOnFocusChange="{TemplateBinding ScrollViewer.BringIntoViewOnFocusChange}"
                                      AutomationProperties.AccessibilityView="Raw">
                            <Border BorderBrush="{TemplateBinding BorderBrush}"
                                    Background="{TemplateBinding Background}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    Margin="{TemplateBinding Padding}">
                                <ItemsPresenter Header="{TemplateBinding Header}"
                                                HeaderTemplate="{TemplateBinding HeaderTemplate}"
                                                HeaderTransitions="{TemplateBinding HeaderTransitions}"
                                                Footer="{TemplateBinding Footer}"
                                                FooterTemplate="{TemplateBinding FooterTemplate}"
                                                FooterTransitions="{TemplateBinding FooterTransitions}" />
                            </Border>
                        </ScrollViewer>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BubbleListViewStyle"
               TargetType="ListView">
            <Setter Property="IsTabStop"
                    Value="False" />
            <Setter Property="TabNavigation"
                    Value="Once" />
            <Setter Property="IsSwipeEnabled"
                    Value="True" />
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility"
                    Value="Disabled" />
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility"
                    Value="Auto" />
            <Setter Property="ScrollViewer.HorizontalScrollMode"
                    Value="Disabled" />
            <Setter Property="ScrollViewer.IsHorizontalRailEnabled"
                    Value="False" />
            <Setter Property="ScrollViewer.VerticalScrollMode"
                    Value="Enabled" />
            <Setter Property="ScrollViewer.IsVerticalRailEnabled"
                    Value="True" />
            <Setter Property="ScrollViewer.ZoomMode"
                    Value="Disabled" />
            <Setter Property="ScrollViewer.IsDeferredScrollingEnabled"
                    Value="False" />
            <Setter Property="ScrollViewer.BringIntoViewOnFocusChange"
                    Value="True" />
            <Setter Property="UseSystemFocusVisuals"
                    Value="True" />
            <Setter Property="ItemContainerTransitions">
                <Setter.Value>
                    <TransitionCollection>
                        <AddDeleteThemeTransition />
                        <ContentThemeTransition />
                        <ReorderThemeTransition />
                        <EntranceThemeTransition IsStaggeringEnabled="False" />
                    </TransitionCollection>
                </Setter.Value>
            </Setter>
            <Setter Property="ItemsPanel">
                <Setter.Value>
                    <ItemsPanelTemplate>
                        <ItemsStackPanel Orientation="Vertical" />
                    </ItemsPanelTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListView">
                        <Border BorderBrush="{TemplateBinding BorderBrush}"
                                Background="{TemplateBinding Background}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="ScrollViewer"
                                          TabNavigation="{TemplateBinding TabNavigation}"
                                          HorizontalScrollMode="{TemplateBinding ScrollViewer.HorizontalScrollMode}"
                                          HorizontalScrollBarVisibility="{TemplateBinding ScrollViewer.HorizontalScrollBarVisibility}"
                                          IsHorizontalScrollChainingEnabled="{TemplateBinding ScrollViewer.IsHorizontalScrollChainingEnabled}"
                                          VerticalScrollMode="{TemplateBinding ScrollViewer.VerticalScrollMode}"
                                          VerticalScrollBarVisibility="{TemplateBinding ScrollViewer.VerticalScrollBarVisibility}"
                                          VerticalSnapPointsType="None"
                                          IsVerticalScrollChainingEnabled="{TemplateBinding ScrollViewer.IsVerticalScrollChainingEnabled}"
                                          IsHorizontalRailEnabled="{TemplateBinding ScrollViewer.IsHorizontalRailEnabled}"
                                          IsVerticalRailEnabled="{TemplateBinding ScrollViewer.IsVerticalRailEnabled}"
                                          ZoomMode="{TemplateBinding ScrollViewer.ZoomMode}"
                                          IsDeferredScrollingEnabled="{TemplateBinding ScrollViewer.IsDeferredScrollingEnabled}"
                                          BringIntoViewOnFocusChange="{TemplateBinding ScrollViewer.BringIntoViewOnFocusChange}"
                                          AutomationProperties.AccessibilityView="Raw"
                                          CanContentRenderOutsideBounds="True">
                                <ItemsPresenter Header="{TemplateBinding Header}"
                                                HeaderTemplate="{TemplateBinding HeaderTemplate}"
                                                HeaderTransitions="{TemplateBinding HeaderTransitions}"
                                                Footer="{TemplateBinding Footer}"
                                                FooterTemplate="{TemplateBinding FooterTemplate}"
                                                FooterTransitions="{TemplateBinding FooterTransitions}"
                                                Padding="{TemplateBinding Padding}" />
                            </ScrollViewer>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Region Service -->

        <DataTemplate x:Name="ServiceMessagePhotoTemplate">
            <messages:MessageService x:Name="Service"
                                     Click="ServiceMessage_Click"
                                     Margin="0,4,0,0"
                                     Padding="12,2,12,0"
                                     Width="216">
                <StackPanel>
                    <controls:ActiveStoriesSegments x:Name="Segments"
                                                    IsClickEnabled="False"
                                                    IsEnabled="False"
                                                    Width="120"
                                                    Height="120"
                                                    Margin="0,10,0,12">
                        <controls:ProfilePicture x:Name="Photo"
                                                 Width="120"
                                                 Height="120" />
                    </controls:ActiveStoriesSegments>

                    <controls:FormattedTextBlock x:Name="Text"
                                                 Foreground="White"
                                                 TextAlignment="Center"
                                                 TextStyle="{StaticResource CaptionRichTextBlockStyle}"
                                                 FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                                 AutoFontSize="False"
                                                 IsTextSelectionEnabled="False"
                                                 HyperlinkStyle="None"
                                                 HyperlinkForeground="#FFFFFF"
                                                 HyperlinkFontWeight="SemiBold"
                                                 Padding="0,0,0,4" />

                    <Border x:Name="View"
                            Background="{ThemeResource MessageServiceBackgroundBrush}"
                            CornerRadius="12"
                            HorizontalAlignment="Center"
                            Padding="12,4,12,4"
                            Margin="0,8,0,12">
                        <TextBlock Text="{CustomResource ViewPhotoAction}"
                                   Foreground="#FFFFFF"
                                   TextAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}" />
                    </Border>
                </StackPanel>
            </messages:MessageService>
        </DataTemplate>

        <DataTemplate x:Name="ServiceMessageBackgroundTemplate">
            <messages:MessageService x:Name="Service"
                                     Click="ServiceMessage_Click"
                                     Margin="0,4,0,0"
                                     Padding="12,2,12,0"
                                     Width="216">
                <StackPanel>
                    <chats:ChatBackgroundPresenter x:Name="Photo"
                                                   IsEnabled="False"
                                                   Width="120"
                                                   Height="120"
                                                   CornerRadius="60"
                                                   Margin="0,10,0,12" />

                    <controls:FormattedTextBlock x:Name="Text"
                                                 Foreground="White"
                                                 TextAlignment="Center"
                                                 TextStyle="{StaticResource CaptionRichTextBlockStyle}"
                                                 FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                                 AutoFontSize="False"
                                                 IsTextSelectionEnabled="False"
                                                 HyperlinkStyle="None"
                                                 HyperlinkForeground="#FFFFFF"
                                                 HyperlinkFontWeight="SemiBold"
                                                 Padding="0,0,0,4"
                                                 Margin="0,0,0,8" />

                    <Border x:Name="View"
                            Background="{ThemeResource MessageServiceBackgroundBrush}"
                            CornerRadius="12"
                            HorizontalAlignment="Center"
                            Padding="12,4,12,4"
                            Margin="0,0,0,12">
                        <TextBlock Text="{CustomResource ViewWallpaperAction}"
                                   Foreground="#FFFFFF"
                                   TextAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}" />
                    </Border>
                </StackPanel>
            </messages:MessageService>
        </DataTemplate>

        <DataTemplate x:Name="ServiceMessageGiftTemplate">
            <messages:MessageService x:Name="Service"
                                     Click="ServiceMessage_Click"
                                     Margin="0,4,0,0"
                                     Padding="12,2,12,0"
                                     Width="216">
                <StackPanel>
                    <controls:AnimatedImage x:Name="Animation"
                                            Width="120"
                                            Height="120"
                                            FrameSize="120,120"
                                            DecodeFrameType="Logical"
                                            IsViewportAware="True"
                                            LoopCount="1"
                                            Margin="0,-20,0,12" />

                    <TextBlock x:Name="Title"
                               Foreground="#FFFFFF"
                               Text="{CustomResource BoostingCongratulations}"
                               TextAlignment="Center"
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                               FontSize="16" />

                    <controls:FormattedTextBlock x:Name="Text"
                                                 Foreground="#FFFFFF"
                                                 TextAlignment="Center"
                                                 TextStyle="{StaticResource CaptionRichTextBlockStyle}"
                                                 FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                                 AutoFontSize="False"
                                                 IsTextSelectionEnabled="False"
                                                 HyperlinkStyle="None"
                                                 HyperlinkForeground="#FFFFFF"
                                                 HyperlinkFontWeight="SemiBold"
                                                 Padding="0,0,0,4"
                                                 Margin="0,0,0,8" />

                    <Border x:Name="View"
                            Background="{ThemeResource MessageServiceBackgroundBrush}"
                            CornerRadius="12"
                            HorizontalAlignment="Center"
                            Padding="12,4,12,4"
                            Margin="0,0,0,12">
                        <TextBlock Text="{CustomResource BoostingReceivedGiftOpenBtn}"
                                   Foreground="#FFFFFF"
                                   TextAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}" />
                    </Border>
                </StackPanel>
            </messages:MessageService>
        </DataTemplate>

        <DataTemplate x:Name="ServiceMessageGiftedTemplate">
            <messages:MessageService>
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <ContentPresenter HorizontalContentAlignment="Stretch"
                                          VerticalContentAlignment="Stretch" />
                    </ControlTemplate>
                </Button.Template>
                <StackPanel>
                    <messages:MessageService Click="ServiceMessage_Click"
                                             Margin="0,4,0,0"
                                             Padding="12,2,12,0"
                                             MaxWidth="480">
                        <controls:FormattedTextBlock x:Name="Text"
                                                     Foreground="#FFFFFF"
                                                     TextAlignment="Center"
                                                     TextStyle="{StaticResource CaptionRichTextBlockStyle}"
                                                     FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                                     AutoFontSize="False"
                                                     IsTextSelectionEnabled="False"
                                                     HyperlinkStyle="None"
                                                     HyperlinkForeground="#FFFFFF"
                                                     HyperlinkFontWeight="SemiBold"
                                                     Padding="0,0,0,4" />
                    </messages:MessageService>

                    <Grid Width="216">
                        <messages:MessageService x:Name="Service"
                                                 Click="ServiceMessage_Click"
                                                 Margin="0,4,0,0"
                                                 Padding="12,2,12,0"
                                                 Width="216">
                            <StackPanel>
                                <controls:AnimatedImage x:Name="Animation"
                                                        Width="120"
                                                        Height="120"
                                                        FrameSize="120,120"
                                                        DecodeFrameType="Logical"
                                                        IsViewportAware="True"
                                                        LoopCount="1"
                                                        Margin="0,-20,0,12" />

                                <TextBlock x:Name="Title"
                                           Foreground="#FFFFFF"
                                           Text="{CustomResource BoostingCongratulations}"
                                           TextAlignment="Center"
                                           Style="{StaticResource SubtitleTextBlockStyle}"
                                           FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                           FontSize="16" />

                                <controls:FormattedTextBlock x:Name="Subtitle"
                                                             Foreground="#FFFFFF"
                                                             TextAlignment="Center"
                                                             TextStyle="{StaticResource CaptionRichTextBlockStyle}"
                                                             FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                                             AutoFontSize="False"
                                                             IsTextSelectionEnabled="False"
                                                             Padding="0,0,0,4"
                                                             Margin="0,0,0,8" />

                                <Border x:Name="View"
                                        Background="{ThemeResource MessageServiceBackgroundBrush}"
                                        CornerRadius="12"
                                        HorizontalAlignment="Center"
                                        Padding="12,4,12,4"
                                        Margin="0,0,0,12">
                                    <TextBlock x:Name="ViewLabel"
                                               Text="{CustomResource BoostingReceivedGiftOpenBtn}"
                                               Foreground="#FFFFFF"
                                               TextAlignment="Center"
                                               Style="{StaticResource CaptionTextBlockStyle}" />
                                </Border>
                            </StackPanel>
                        </messages:MessageService>

                        <Grid x:Name="RibbonRoot"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Top"
                              Margin="0,2,-2,0"
                              Width="72"
                              Height="72">
                            <Path Data="M69.6569 41.1569L30.8431 2.34315C29.3429 0.842855 27.308 0 25.1863 0H2.82843C1.04662 0 0.154286 2.15429 1.41422 3.41422L68.5858 70.5858C69.8457 71.8457 72 70.9534 72 69.1716V46.8137C72 44.692 71.1571 42.6571 69.6569 41.1569Z"
                                  Fill="{StaticResource MessageServiceBackgroundBrush}" />

                            <Border Width="72"
                                    VerticalAlignment="Center"
                                    RenderTransformOrigin="0.5,0.5"
                                    Margin="0,-14,-14,0">
                                <Border.RenderTransform>
                                    <RotateTransform Angle="45" />
                                </Border.RenderTransform>
                                <TextBlock x:Name="Ribbon"
                                           Foreground="#FFFFFF"
                                           TextAlignment="Center"
                                           FontSize="12" />
                            </Border>
                        </Grid>
                    </Grid>
                </StackPanel>
            </messages:MessageService>
        </DataTemplate>

        <DataTemplate x:Name="ServiceMessageTemplate">
            <messages:MessageService Click="ServiceMessage_Click"
                                     Margin="0,4,0,0"
                                     Padding="12,2,12,0"
                                     MaxWidth="480">
                <controls:FormattedTextBlock x:Name="Text"
                                             Foreground="#FFFFFF"
                                             TextAlignment="Center"
                                             TextStyle="{StaticResource CaptionRichTextBlockStyle}"
                                             FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                             AutoFontSize="False"
                                             IsTextSelectionEnabled="False"
                                             HyperlinkStyle="None"
                                             HyperlinkForeground="#FFFFFF"
                                             HyperlinkFontWeight="SemiBold"
                                             Padding="0,0,0,4" />
            </messages:MessageService>
        </DataTemplate>

        <DataTemplate x:Name="ServiceMessageUnreadTemplate">
            <messages:MessageService AutomationProperties.Name="{CustomResource UnreadMessages}"
                                     HorizontalAlignment="Stretch"
                                     CornerRadius="0"
                                     Margin="0,4,0,0"
                                     Padding="0">
                <Grid>
                    <TextBlock Text="{CustomResource UnreadMessages}"
                               Foreground="#FFFFFF"
                               Padding="0"
                               Margin="0,3,0,5"
                               TextAlignment="Center"
                               Style="{StaticResource SettingsGroupTextBlockStyle}" />

                    <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}"
                              Foreground="#FFFFFF"
                              Glyph="&#xE0E5;"
                              FontSize="16"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Margin="0,0,24,0" />
                </Grid>
            </messages:MessageService>
        </DataTemplate>

        <!-- EndRegion -->

        <DataTemplate x:Name="OutgoingMessageTemplate">
            <messages:MessageSelector>
                <messages:MessageBubble x:Name="Bubble"
                                        HorizontalAlignment="Right">
                    <FrameworkElement.Resources>
                        <common:ThemeOutgoing />
                    </FrameworkElement.Resources>
                </messages:MessageBubble>
            </messages:MessageSelector>
        </DataTemplate>

        <DataTemplate x:Name="IncomingMessageTemplate">
            <messages:MessageSelector>
                <messages:MessageBubble x:Name="Bubble"
                                        HorizontalAlignment="Left">
                    <FrameworkElement.Resources>
                        <common:ThemeIncoming />
                    </FrameworkElement.Resources>
                </messages:MessageBubble>
            </messages:MessageSelector>
        </DataTemplate>
    </UserControl.Resources>

    <Grid x:Name="LayoutRoot"
          Background="Transparent"
          AllowDrop="True"
          DragOver="OnDragOver"
          Drop="OnDrop">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState x:Name="FilledState" />
                <VisualState x:Name="SidebarState">
                    <VisualState.Setters>
                        <Setter Target="StickersPanel.(Grid.Column)"
                                Value="1" />
                        <Setter Target="StickersPanel.(Grid.Row)"
                                Value="0" />
                        <Setter Target="StickersPanel.(Grid.RowSpan)"
                                Value="5" />
                        <Setter Target="StickersPanel.Width"
                                Value="320" />
                        <Setter Target="StickersPanel.Margin"
                                Value="0" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
            <VisualStateGroup>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                </VisualState>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="500" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="Show.Width"
                                Value="376*" />
                        <Setter Target="Show.MaxWidth"
                                Value="376" />
                        <Setter Target="Hide.Width"
                                Value="*" />
                        <!--<Setter Target="BackgroundElement.BorderThickness" Value="1"/>
                             <Setter Target="BackgroundElement.Margin" Value="8"/>-->
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition />
            <RowDefinition Height="Auto" />
            <RowDefinition x:Name="KeyboardPlaceholder"
                           Height="Auto" />
        </Grid.RowDefinitions>
        <Grid Padding="0,0,0,8"
              VerticalAlignment="Bottom"
              Grid.RowSpan="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="Show" />
                <ColumnDefinition x:Name="Hide"
                                  Width="0" />
            </Grid.ColumnDefinitions>
            <Border x:Name="FlyoutArea"
                    MinHeight="{ThemeResource TelegramToolBarHeight}" />
        </Grid>

        <Grid x:Name="Header"
              Height="{StaticResource NavigationViewTopPaneHeight}"
              Canvas.ZIndex="3">
            <Border BorderBrush="{ThemeResource NavigationViewContentGridBorderBrush}"
                    BorderThickness="0,0,0,1" />
            <Grid x:Name="HeaderLeft"
                  HorizontalAlignment="Left"
                  Canvas.ZIndex="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <controls:BackButton x:Name="BackButton"
                                     RenderTransformOrigin="0.5,0.5"
                                     Width="48"
                                     Height="48"
                                     Margin="4,0,-8,0"
                                     CornerRadius="20"
                                     Glyph="&#xe93e;">
                    <Button.RenderTransform>
                        <ScaleTransform ScaleX="0.8"
                                        ScaleY="0.8" />
                    </Button.RenderTransform>
                </controls:BackButton>

                <controls:ActiveStoriesSegments x:Name="Segments"
                                                Click="Segments_Click"
                                                Width="36"
                                                Height="36"
                                                HorizontalAlignment="Center"
                                                Margin="0,0,12,0"
                                                AutomationProperties.Name="{CustomResource AccDescrProfilePicture}"
                                                Grid.Column="1">
                    <controls:ProfilePicture x:Name="Photo"
                                             Width="36"
                                             Height="36" />
                </controls:ActiveStoriesSegments>

                <controls:CustomEmojiIcon x:Name="Icon"
                                          x:Load="False"
                                          AutomationProperties.Name="{CustomResource AccDescrProfilePicture}"
                                          Width="32"
                                          Height="32"
                                          FrameSize="32,32"
                                          DecodeFrameType="Logical"
                                          HorizontalAlignment="Center"
                                          Grid.Column="1" />

            </Grid>

            <local:ChatHeaderButton x:Name="Profile"
                                    Click="Profile_Click"
                                    Style="{StaticResource AccentTextButtonStyle}"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Stretch"
                                    HorizontalContentAlignment="Stretch"
                                    VerticalContentAlignment="Stretch"
                                    BorderThickness="0"
                                    CornerRadius="0"
                                    Padding="92,0,0,0">
                <Grid Background="Transparent"
                      VerticalAlignment="Center"
                      Margin="0,-2,0,2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid HorizontalAlignment="Left">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="Title"
                                   Foreground="{ThemeResource PageHeaderForegroundBrush}"
                                   Style="{StaticResource BaseTextBlockStyle}"
                                   FontFamily="{ThemeResource EmojiThemeFontFamilyWithSymbols}"
                                   TextWrapping="NoWrap"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="1" />

                        <controls:IdentityIcon x:Name="Identity"
                                               VerticalAlignment="Bottom"
                                               Margin="4,0,0,0"
                                               Grid.Column="1" />
                    </Grid>

                    <Grid Visibility="{x:Bind ViewModel.LastSeen, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                          Grid.Row="1">
                        <TextBlock x:Name="Subtitle"
                                   Text="{x:Bind ViewModel.Subtitle, Mode=OneWay}"
                                   Foreground="{ThemeResource PageHeaderDisabledBrush}"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   TextWrapping="NoWrap"
                                   TextTrimming="CharacterEllipsis" />
                        <StackPanel x:Name="ChatActionPanel"
                                    Orientation="Horizontal"
                                    Visibility="Collapsed">
                            <chats:ChatActionIndicator x:Name="ChatActionIndicator"
                                                       Fill="{ThemeResource PageHeaderHighlightBrush}"
                                                       VerticalAlignment="Bottom"
                                                       Width="20"
                                                       Height="20"
                                                       Margin="0,-2,4,-2" />
                            <TextBlock x:Name="ChatActionLabel"
                                       TextWrapping="NoWrap"
                                       TextTrimming="CharacterEllipsis"
                                       Foreground="{ThemeResource PageHeaderHighlightBrush}"
                                       FontFamily="{ThemeResource EmojiThemeFontFamily}"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       VerticalAlignment="Top" />
                        </StackPanel>
                    </Grid>
                </Grid>
            </local:ChatHeaderButton>

            <Grid x:Name="Options"
                  SizeChanged="Options_SizeChanged"
                  HorizontalAlignment="Right">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Grid x:Name="SecondaryOptions">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <controls:GlyphButton x:Name="VideoCall"
                                          Visibility="Collapsed"
                                          Click="{x:Bind ViewModel.VideoCall}"
                                          Style="{StaticResource HeaderGlyphButtonStyle}"
                                          Glyph="&#xE714;"
                                          FontSize="20"
                                          AutomationProperties.Name="{CustomResource VideoCall}"
                                          ToolTipService.ToolTip="{CustomResource VideoCall}"
                                          Margin="0,0,-4,0" />

                    <controls:GlyphButton x:Name="Call"
                                          Visibility="Collapsed"
                                          Click="{x:Bind ViewModel.VoiceCall}"
                                          Style="{StaticResource HeaderGlyphButtonStyle}"
                                          Glyph="&#xE717;"
                                          AutomationProperties.Name="{CustomResource Call}"
                                          ToolTipService.ToolTip="{CustomResource Call}"
                                          Margin="0,0,-4,0"
                                          Grid.Column="1" />

                    <controls:GlyphButton x:Name="SearchOption"
                                          Click="{x:Bind Search}"
                                          Style="{StaticResource HeaderGlyphButtonStyle}"
                                          Glyph="&#xE721;"
                                          AutomationProperties.Name="{CustomResource Search}"
                                          ToolTipService.ToolTip="{CustomResource Search}"
                                          Margin="0,0,-4,0"
                                          Grid.Column="2" />

                </Grid>
                <controls:MoreButton Click="Menu_ContextRequested"
                                     Grid.Column="1" />
            </Grid>
        </Grid>

        <StackPanel x:Name="ClipperOuter"
                    VerticalAlignment="Top"
                    Canvas.ZIndex="2"
                    Grid.Row="2">
            <chats:ChatGroupCallHeader x:Name="GroupCall"
                                       JoinClick="{x:Bind ViewModel.JoinGroupCall}"
                                       Visibility="Collapsed"
                                       Canvas.ZIndex="1" />
            <StackPanel x:Name="ClipperJoinRequests">
                <chats:ChatJoinRequestsHeader x:Name="JoinRequests"
                                              Click="{x:Bind ViewModel.ShowJoinRequests}"
                                              Visibility="Collapsed"
                                              Canvas.ZIndex="1" />
                <StackPanel x:Name="ClipperActionBar">
                    <chats:ChatActionBarView x:Name="ActionBar"
                                             Visibility="Collapsed"
                                             Canvas.ZIndex="1" />
                    <StackPanel x:Name="ClipperTranslate">
                        <chats:ChatTranslateBar x:Name="TranslateHeader"
                                                Visibility="Collapsed"
                                                Canvas.ZIndex="1" />
                        <StackPanel x:Name="ClipperConnected">
                            <chats:ChatConnectedBotHeader x:Name="ConnectedBot"
                                                          Visibility="Collapsed"
                                                          Canvas.ZIndex="1" />
                            <Grid x:Name="Clipper">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <!--
                        48: header
                        40: music player
                        40: active call
                        40: group call
                        40: join request
                        32: translate
                        -->
                                <Border x:Name="ClipperBackground"
                                        Background="{ThemeResource PageSubHeaderBackgroundBrush2}"
                                        Margin="0,-248,0,0" />

                                <messages:MessagePinned x:Name="PinnedMessage"
                                                        Click="Reply_Click"
                                                        ActionClick="PinnedAction_Click"
                                                        HideClick="{x:Bind ViewModel.HidePinnedMessage}"
                                                        ListClick="{x:Bind ViewModel.OpenPinnedMessages}"
                                                        Visibility="Collapsed" />

                                <Grid x:Name="CallbackQueryAnswerPanel"
                                      Visibility="{x:Bind ViewModel.InformativeMessage, Converter={StaticResource NullToVisibilityConverter}, Mode=OneWay}"
                                      Background="{ThemeResource PageSubHeaderBackgroundBrush}"
                                      MinHeight="{ThemeResource AppBarThemeCompactHeight}">
                                    <messages:MessageReply x:Name="CallbackQueryAnswer"
                                                           VerticalAlignment="Stretch"
                                                           Padding="12,6"
                                                           IsHitTestVisible="False" />
                                </Grid>

                                <Border x:Name="DateHeaderRelative"
                                        SizeChanged="DateHeaderPanel_SizeChanged"
                                        Grid.Row="1">
                                    <Border x:Name="DateHeaderPanel"
                                            Visibility="Collapsed"
                                            HorizontalAlignment="Center">
                                        <messages:MessageService x:Name="DateHeader"
                                                                 Click="Date_Click"
                                                                 BorderThickness="0,4,0,0">
                                            <TextBlock x:Name="DateHeaderLabel"
                                                       Text="31 dicembre 2017"
                                                       Foreground="White"
                                                       TextAlignment="Center"
                                                       FontFamily="{ThemeResource EmojiThemeFontFamily}"
                                                       Style="{StaticResource CaptionTextBlockStyle}" />
                                        </messages:MessageService>
                                    </Border>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </StackPanel>

        <Grid x:Name="ContentPanel"
              SizeChanged="ContentPanel_SizeChanged"
              Grid.Row="2">
            <chats:ChatHistoryView x:Name="Messages"
                                   Style="{StaticResource BubbleListViewStyle}"
                                   ShowsScrollingPlaceholders="False"
                                   IsItemClickEnabled="False"
                                   IsSelectionEnabled="{x:Bind ViewModel.IsSelectionEnabled, Mode=TwoWay}"
                                   SelectionMode="None"
                                   ViewChanged="OnViewChanged"
                                   ChoosingItemContainer="OnChoosingItemContainer"
                                   ContainerContentChanging="OnContainerContentChanging"
                                   Margin="0,0,0,8"
                                   Grid.ColumnSpan="2">
                <ListView.Resources>
                    <CornerRadius x:Key="ListViewItemCornerRadius">0</CornerRadius>
                </ListView.Resources>
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <ItemsStackPanel Loading="ItemsStackPanel_Loading"
                                         SizeChanged="OnViewSizeChanged"
                                         ItemsUpdatingScrollMode="KeepItemsInView"
                                         VerticalAlignment="Bottom" />
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
                <ListView.ItemContainerTransitions>
                    <TransitionCollection />
                </ListView.ItemContainerTransitions>
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem"
                           BasedOn="{StaticResource DefaultListViewItemStyle}">
                        <Setter Property="FontFamily"
                                Value="{ThemeResource ContentControlThemeFontFamily}" />
                        <Setter Property="FontSize"
                                Value="{ThemeResource ControlContentThemeFontSize}" />
                        <Setter Property="Background"
                                Value="Transparent" />
                        <Setter Property="Foreground"
                                Value="{ThemeResource SystemControlForegroundBaseHighBrush}" />
                        <Setter Property="TabNavigation"
                                Value="Local" />
                        <Setter Property="IsHoldingEnabled"
                                Value="True" />
                        <Setter Property="IsTabStop"
                                Value="False" />
                        <Setter Property="Padding"
                                Value="0,0,0,0" />
                        <Setter Property="HorizontalContentAlignment"
                                Value="Stretch" />
                        <Setter Property="VerticalContentAlignment"
                                Value="Stretch" />
                        <Setter Property="MinWidth"
                                Value="{ThemeResource ListViewItemMinWidth}" />
                        <Setter Property="MinHeight"
                                Value="0" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.Header>
                    <Grid Padding="0,48,0,0">
                        <!--<Grid.RowDefinitions>
                             <RowDefinition/>
                             <RowDefinition Height="Auto"/>
                             </Grid.RowDefinitions>
                             <StackPanel x:Name="BotInfoPanel"
                             Visibility="Collapsed"
                             Padding="{ThemeResource MessageContentPadding}"
                             Background="{ThemeResource MessageBackgroundBrush}"
                             BorderBrush="{ThemeResource MessageBorderBrush}"
                             BorderThickness="0,0,0,2"
                             VerticalAlignment="Center"
                             MaxWidth="360"
                             Margin="12,12,12,8">
                             <TextBlock Text="What can this bot do?" Style="{StaticResource BaseTextBlockStyle}"/>
                             <TextBlock Style="{StaticResource BodyTextBlockStyle}"/>
                             </StackPanel>-->
                        <!--<Border Height="4"
                                Grid.Row="1" />-->
                    </Grid>
                </ListView.Header>
            </chats:ChatHistoryView>

            <StackPanel x:Name="EmptyChatRoot"
                        x:Load="False"
                        VerticalAlignment="Center">
                <messages:MessageService Click="EmptyChat_Click"
                                         HorizontalAlignment="Center"
                                         VerticalAlignment="Center"
                                         Padding="12,8,12,12"
                                         Width="216">
                    <StackPanel>
                        <TextBlock x:Name="EmptyChatTitle"
                                   TextAlignment="Center"
                                   TextWrapping="Wrap"
                                   Foreground="#FFFFFF"
                                   Style="{StaticResource BaseTextBlockStyle}" />
                        <TextBlock x:Name="EmptyChatMessage"
                                   TextAlignment="Center"
                                   TextWrapping="Wrap"
                                   Foreground="#FFFFFF"
                                   Style="{StaticResource BodyTextBlockStyle}"
                                   Margin="0,0,0,12" />
                        <controls:AnimatedImage x:Name="EmptyChatAnimated"
                                                Width="140"
                                                Height="140"
                                                FrameSize="140,140"
                                                DecodeFrameType="Logical"
                                                IsViewportAware="True"
                                                LoopCount="0" />
                    </StackPanel>
                </messages:MessageService>

                <messages:MessageService x:Name="EmptyChatHowRoot"
                                         Click="EmptyChatHow_Click"
                                         Margin="0,8,0,0"
                                         Padding="12,2,12,0">
                    <TextBlock x:Name="EmptyChatHow"
                               Foreground="#FFFFFF"
                               TextAlignment="Center"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                               Padding="0,0,0,4" />
                </messages:MessageService>
            </StackPanel>

            <messages:MessageService x:Name="RestrictsNewChats"
                                     x:Load="False"
                                     Click="RestrictsNewChats_Click"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center"
                                     Padding="12,0,12,0"
                                     Width="216">
                <StackPanel>
                    <Border Background="{ThemeResource MessageServiceBackgroundBrush}"
                            CornerRadius="60"
                            HorizontalAlignment="Center"
                            Margin="0,12,0,12">
                        <controls:AnimatedImage Source="ms-appx:///Assets/Animations/RestrictsNewChats.tgs"
                                                Width="120"
                                                Height="120"
                                                FrameSize="120,120"
                                                DecodeFrameType="Logical"
                                                IsViewportAware="True"
                                                LoopCount="1" />
                    </Border>


                    <TextBlock x:Name="RestrictsNewChatsText"
                               Foreground="#FFFFFF"
                               TextAlignment="Center"
                               Style="{StaticResource BodyTextBlockStyle}"
                               FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                               Padding="0,0,0,4"
                               Margin="0,0,0,8" />

                    <Border Background="{ThemeResource MessageServiceBackgroundBrush}"
                            CornerRadius="12"
                            HorizontalAlignment="Center"
                            Padding="12,4,12,4"
                            Margin="0,0,0,12">
                        <TextBlock Text="{CustomResource MessagePremiumUnlock}"
                                   Foreground="#FFFFFF"
                                   TextAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}" />
                    </Border>
                </StackPanel>
            </messages:MessageService>


            <chats:ChatHistoryArrows x:Name="Arrows"
                                     UnreadCount="{x:Bind ViewModel.UnreadCount, Mode=OneWay}"
                                     NextMention="{x:Bind ViewModel.Mentions.NextMessage}"
                                     ReadMentions="{x:Bind ViewModel.ReadMentions}"
                                     NextReaction="{x:Bind ViewModel.Reactions.NextMessage}"
                                     ReadReactions="{x:Bind ViewModel.ReadReactions}"
                                     ReadMessages="{x:Bind ViewModel.ReadMessages}"
                                     NextMessage="{x:Bind ViewModel.PreviousSlice}"
                                     HorizontalAlignment="Right"
                                     VerticalAlignment="Bottom" />

            <Grid x:Name="InlinePanel"
                  SizeChanged="InlinePanel_SizeChanged"
                  VerticalAlignment="Bottom"
                  Visibility="{x:Bind ViewModel.Search, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=invert}"
                  Margin="12,0,12,-12"
                  CornerRadius="8,8,0,0">
                <controls:InlineBotResultsView x:Name="ListInline"
                                               x:Load="{x:Bind ViewModel.IsInlineBotResultsVisible, Mode=OneWay}"
                                               Background="{ThemeResource PageSubHeaderBackgroundBrush2}"
                                               Loaded="InlineBotResults_Loaded"
                                               ItemClick="InlineBotResults_ItemClick"
                                               VerticalAlignment="Bottom" />
                <controls:OrientableListView x:Name="ListAutocomplete"
                                             Visibility="Collapsed"
                                             Background="{ThemeResource PageSubHeaderBackgroundBrush2}"
                                             ItemTemplateSelector="{StaticResource AutocompleteTemplate}"
                                             ChoosingItemContainer="Autocomplete_ChoosingItemContainer"
                                             ContainerContentChanging="Autocomplete_ContainerContentChanging"
                                             AllowFocusOnInteraction="False"
                                             IsItemClickEnabled="True"
                                             ItemClick="Autocomplete_ItemClick"
                                             VerticalAlignment="Bottom"
                                             Style="{StaticResource ZoomableListViewStyle}"
                                             Padding="0,0,0,12">
                    <GridView.ItemContainerStyle>
                        <Style TargetType="GridViewItem"
                               BasedOn="{StaticResource ZoomableListViewItemStyle}">
                            <Setter Property="MinWidth"
                                    Value="0" />
                            <Setter Property="Padding"
                                    Value="0" />
                        </Style>
                    </GridView.ItemContainerStyle>
                    <GridView.ItemContainerTransitions>
                        <TransitionCollection />
                    </GridView.ItemContainerTransitions>
                </controls:OrientableListView>
            </Grid>
        </Grid>

        <ScrollViewer x:Name="ReplyMarkupPanel"
                      MaxHeight="260"
                      VerticalScrollBarVisibility="Auto"
                      VerticalScrollMode="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      HorizontalScrollMode="Disabled"
                      Background="{ThemeResource PageSubHeaderBackgroundBrush2}"
                      Visibility="Collapsed"
                      Grid.Row="4">
            <controls:ReplyMarkupPanel x:Name="ReplyMarkup"
                                       AllowFocusOnInteraction="False"
                                       ButtonClick="ReplyMarkup_ButtonClick"
                                       Margin="8,0,8,4" />
        </ScrollViewer>

        <controls:StickerPanel x:Name="StickersPanel"
                               Visibility="Collapsed"
                               Margin="0,56,0,56"
                               MaxWidth="664"
                               Canvas.ZIndex="3"
                               Grid.Row="2"
                               Grid.RowSpan="2" />

        <!-- Input pane -->
        <Border x:Name="Separator"
                Margin="12,0"
                Grid.Row="3" />

        <ContentControl x:Name="TextArea"
                        IsTabStop="False"
                        HorizontalContentAlignment="Stretch"
                        VerticalContentAlignment="Stretch"
                        Margin="12,0,12,8"
                        Grid.Row="3">
            <Grid x:Name="TextRoot"
                  Background="{ThemeResource PageSubHeaderBackgroundBrush2}"
                  MinHeight="{StaticResource TelegramToolBarHeight}"
                  SizeChanged="TextArea_SizeChanged"
                  CornerRadius="15">
                <Grid x:Name="TextMain"
                      VerticalAlignment="Bottom">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <Grid x:Name="ComposerHeader"
                          Visibility="Collapsed"
                          Grid.ColumnSpan="5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="48" />
                            <ColumnDefinition />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Border VerticalAlignment="Stretch"
                                Margin="0,0,4,-4"
                                Grid.Column="1"
                                Grid.ColumnSpan="2">
                            <messages:MessageReply x:Name="ComposerHeaderReference"
                                                   Click="Reply_Click"
                                                   ContextRequested="Reply_ContextRequested"
                                                   CornerRadius="4,13,4,4"
                                                   Padding="0,0,40,0" />
                        </Border>
                        <FontIcon x:Name="ComposerHeaderGlyph"
                                  Foreground="{ThemeResource MessageHeaderBorderBrush}"
                                  Style="{StaticResource DefaultFontIconStyle}"
                                  Margin="0,0,0,-4"
                                  FontSize="24" />

                        <controls:ProgressBarRing x:Name="ComposerHeaderUpload"
                                                  Background="Transparent"
                                                  Foreground="{ThemeResource MessageHeaderBorderBrush}" />

                        <controls:GlyphButton x:Name="ComposerHeaderCancel"
                                              Click="{x:Bind ViewModel.ClearReply}"
                                              FontSize="{StaticResource GlyphLargeFontSize}"
                                              Foreground="{ThemeResource MessageHeaderBorderBrush}"
                                              AllowFocusOnInteraction="False"
                                              Glyph="&#xE711;"
                                              Margin="0,0,0,-4"
                                              Height="52"
                                              Grid.Column="2" />
                    </Grid>

                    <Button x:Name="ButtonMore"
                            Click="ButtonMore_Click"
                            Style="{StaticResource AccentButtonStyle}"
                            BorderBrush="{ThemeResource AccentButtonBackground}"
                            AutomationProperties.Name="{CustomResource AccDescrBotCommands}"
                            ToolTipService.ToolTip="{CustomResource AccDescrBotCommands}"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Bottom"
                            Visibility="Collapsed"
                            CornerRadius="16"
                            Margin="8,8,0,8"
                            Grid.Row="1" />

                    <HyperlinkButton x:Name="ButtonAlias"
                                     Click="ButtonAlias_Click"
                                     Style="{StaticResource EmptyHyperlinkButtonStyle}"
                                     AutomationProperties.Name="{CustomResource SendMessageAsTitle}"
                                     ToolTipService.ToolTip="{CustomResource SendMessageAsTitle}"
                                     HorizontalAlignment="Left"
                                     VerticalAlignment="Bottom"
                                     Visibility="Collapsed"
                                     Margin="8,8,0,8"
                                     Grid.Row="1">
                        <controls:ProfilePicture x:Name="PhotoAlias"
                                                 Width="32"
                                                 Height="32" />
                    </HyperlinkButton>

                    <Border x:Name="TextFieldPanel"
                            Grid.ColumnSpan="2"
                            Grid.Column="1"
                            Grid.Row="1">
                        <chats:ChatTextBox x:Name="TextField"
                                           FontFamily="{ThemeResource EmojiThemeFontFamily}"
                                           Background="Transparent"
                                           ControlledList="{x:Bind ListAutocomplete}"
                                           CreateLinkTarget="{x:Bind ButtonAttach}"
                                           AcceptsReturn="False"
                                           BorderThickness="0"
                                           TextWrapping="Wrap"
                                           InputScope="Chat"
                                           VerticalAlignment="Bottom"
                                           VerticalContentAlignment="Bottom"
                                           PreventKeyboardDisplayOnProgrammaticFocus="True"
                                           MinHeight="{StaticResource TelegramToolBarHeight}"
                                           MaxHeight="192"
                                           TextChanged="TextField_TextChanged"
                                           Capture="TextField_Tapped"
                                           Sending="TextField_Sending" />
                    </Border>
                    <Border x:Name="btnAttach"
                            Grid.Column="1"
                            Grid.Row="1">
                        <controls:AnimatedGlyphButton x:Name="ButtonAttach"
                                                      Click="Attach_Click"
                                                      Glyph="&#xE9D8;"
                                                      AllowFocusOnInteraction="False"
                                                      VerticalAlignment="Bottom"
                                                      FontFamily="{StaticResource TelegramThemeFontFamily}"
                                                      FontSize="{StaticResource GlyphLargeFontSize}"
                                                      AutomationProperties.Name="{CustomResource AccDescrAttachButton}"
                                                      ToolTipService.ToolTip="{CustomResource AccDescrAttachButton}" />
                    </Border>

                    <Grid x:Name="ButtonsPanel"
                          Grid.Column="3"
                          Grid.ColumnSpan="2"
                          Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Grid x:Name="SecondaryButtonsPanel">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Button to access scheduled messages -->
                            <Border x:Name="btnScheduled">
                                <controls:GlyphButton x:Name="ButtonScheduled"
                                                      Glyph="&#xE9DA;"
                                                      Click="{x:Bind ViewModel.ShowScheduled}"
                                                      FontSize="{StaticResource GlyphLargeFontSize}"
                                                      AutomationProperties.Name="{CustomResource ScheduledMessages}"
                                                      ToolTipService.ToolTip="{CustomResource ScheduledMessages}"
                                                      VerticalAlignment="Bottom" />
                            </Border>

                            <!-- Button to toggle silent mode, channels only -->
                            <controls:AnimatedIconToggleButton x:Name="ButtonSilent"
                                                               Click="{x:Bind ViewModel.ToggleSilent}"
                                                               FontSize="{StaticResource GlyphLargeFontSize}"
                                                               VerticalAlignment="Bottom"
                                                               Glyph="&#xE9DF;"
                                                               CheckedGlyph="&#xE9DE;"
                                                               Grid.Column="1">
                                <controls:AnimatedIconToggleButton.Source>
                                    <icons:MuteUnmute />
                                </controls:AnimatedIconToggleButton.Source>
                            </controls:AnimatedIconToggleButton>

                            <!-- Button to change self-destructing timer, secret chats only -->
                            <controls:GlyphButton x:Name="ButtonTimer"
                                                  Glyph="&#xE9DB;"
                                                  Click="{x:Bind ViewModel.SetTimer}"
                                                  FontSize="{StaticResource GlyphLargeFontSize}"
                                                  VerticalAlignment="Bottom"
                                                  Grid.Column="1" />

                            <!-- Button to use bot commands, bots/groups only -->
                            <Border x:Name="btnCommands"
                                    VerticalAlignment="Bottom"
                                    Grid.Column="2">
                                <controls:GlyphButton x:Name="ButtonCommands"
                                                      Click="Commands_Click"
                                                      AllowFocusOnInteraction="False"
                                                      Glyph="&#xE9DC;"
                                                      Visibility="{x:Bind ViewModel.HasBotCommands, Mode=OneWay}"
                                                      FontFamily="{StaticResource TelegramThemeFontFamily}"
                                                      FontSize="{StaticResource GlyphLargeFontSize}"
                                                      VerticalAlignment="Bottom"
                                                      AutomationProperties.Name="{CustomResource AccDescrBotCommands}"
                                                      ToolTipService.ToolTip="{CustomResource AccDescrBotCommands}"
                                                      Grid.Column="1" />
                            </Border>

                            <!-- Button to use bot keyboard, bots/groups only -->
                            <Border x:Name="btnMarkup"
                                    VerticalAlignment="Bottom"
                                    Grid.Column="2">
                                <controls:AnimatedGlyphButton x:Name="ButtonMarkup"
                                                              Click="Markup_Click"
                                                              AllowFocusOnInteraction="False"
                                                              Glyph="&#xE9D5;"
                                                              FontFamily="{StaticResource TelegramThemeFontFamily}"
                                                              FontSize="{StaticResource GlyphLargeFontSize}"
                                                              VerticalAlignment="Bottom"
                                                              AutomationProperties.Name="{CustomResource AccDescrBotKeyboard}"
                                                              ToolTipService.ToolTip="{CustomResource AccDescrBotKeyboard}"
                                                              Grid.Column="1" />
                            </Border>
                        </Grid>

                        <!-- Button to use stickers keyboard, all -->
                        <chats:ChatStickerButton x:Name="ButtonStickers"
                                                 Redirect="Stickers_Redirect"
                                                 ControlledPanel="{x:Bind StickersPanel}"
                                                 AllowFocusOnInteraction="False"
                                                 VerticalAlignment="Bottom"
                                                 AutomationProperties.Name="{CustomResource AccDescrEmojiButton}"
                                                 Grid.Column="1" />
                        <!--ToolTipService.ToolTip="{CustomResource AccDescrEmojiButton}"-->

                        <Grid x:Name="ButtonRecord"
                              VerticalAlignment="Bottom"
                              Grid.Column="2"
                              Canvas.ZIndex="1000">
                            <chats:ChatRecordButton x:Name="btnVoiceMessage"
                                                    AllowFocusOnInteraction="False"
                                                    Glyph="&#xE9E4;"
                                                    CheckedGlyph="&#xE9E0;"
                                                    ManipulationMode="TranslateX,TranslateY">
                                <controls:AnimatedIconToggleButton.Source>
                                    <icons:VoiceVideo />
                                </controls:AnimatedIconToggleButton.Source>
                            </chats:ChatRecordButton>
                        </Grid>

                        <Grid x:Name="SendMessageButton"
                              Grid.Column="2"
                              Canvas.ZIndex="1001"
                              Visibility="Collapsed">
                            <chats:ChatSendButton x:Name="btnSendMessage"
                                                  ContextRequested="Send_ContextRequested"
                                                  VerticalAlignment="Bottom"
                                                  Click="btnSendMessage_Click"
                                                  Glyph="&#xE919;"
                                                  AllowFocusOnInteraction="False"
                                                  AutomationProperties.Name="{CustomResource Send}"
                                                  ToolTipService.ToolTip="{CustomResource Send}" />

                            <Grid x:Name="SendEffectRoot"
                                  IsHitTestVisible="False"
                                  HorizontalAlignment="Right"
                                  VerticalAlignment="Bottom"
                                  Margin="8,4">
                                <Border Background="{ThemeResource SystemColorControlAccentBrush}"
                                        Opacity="0" />
                                <TextBlock x:Name="SendEffectText"
                                           FontFamily="{StaticResource EmojiThemeFontFamilyWithSymbols}"
                                           FontSize="16"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center" />
                                <controls:AnimatedImage x:Name="SendEffect"
                                                        AutoPlay="True"
                                                        Width="16"
                                                        Height="16"
                                                        FrameSize="16,16"
                                                        DecodeFrameType="Logical"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center" />
                                <Popup x:Name="SendEffectInteractionsPopup">
                                    <Grid x:Name="SendEffectInteractions" />
                                </Popup>
                            </Grid>
                        </Grid>

                        <controls:GlyphButton x:Name="btnEdit"
                                              VerticalAlignment="Bottom"
                                              Click="btnSendMessage_Click"
                                              Glyph="&#xEC61;"
                                              AllowFocusOnInteraction="False"
                                              Foreground="{ThemeResource TelegramBackgroundAccentBrush}"
                                              FontSize="24"
                                              Grid.Column="2"
                                              AutomationProperties.Name="{CustomResource Done}"
                                              ToolTipService.ToolTip="{CustomResource Done}"
                                              Visibility="Collapsed" />
                    </Grid>
                </Grid>
            </Grid>
        </ContentControl>

        <chats:ChatRecordBar x:Name="ChatRecord"
                             StartTyping="ChatRecord_StartTyping"
                             CancelTyping="ChatRecord_CancelTyping"
                             ControlledButton="{x:Bind btnVoiceMessage}"
                             Margin="12,0,12,8"
                             Visibility="Collapsed"
                             Grid.Row="3" />

        <Grid x:Name="ChatFooter"
              Margin="12,0,12,8"
              CornerRadius="15"
              Grid.Row="3">
            <chats:ChatBottomButton x:Name="ButtonAction"
                                    LosingFocus="ButtonAction_LosingFocus"
                                    Click="{x:Bind ViewModel.Action}"
                                    Height="{StaticResource TelegramToolBarHeight}">
                <TextBlock />
            </chats:ChatBottomButton>
        </Grid>

        <Grid x:Name="ManagePanel"
              Background="{ThemeResource PageSubHeaderBackgroundBrush2}"
              VerticalAlignment="Bottom"
              Visibility="Collapsed"
              Margin="12,0,12,8"
              CornerRadius="15"
              Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <chats:ChatBottomButton x:Name="ButtonReport"
                                    Content="{x:Bind ConvertReportSelection(ViewModel.SelectedCount), Mode=OneWay}"
                                    Foreground="{ThemeResource DangerButtonBackground}"
                                    Click="{x:Bind ViewModel.ReportSelectedMessages}"
                                    IsEnabled="{x:Bind ViewModel.CanReportSelectedMessages, Mode=OneWay}"
                                    FontWeight="SemiBold"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Center"
                                    Grid.Column="0"
                                    Grid.ColumnSpan="5" />

            <!-- This is terrible, but it prevents accidental clicks while reporting -->
            <Border Background="Transparent" />

            <controls:GlyphButton x:Name="ButtonManage"
                                  Glyph="&#xE711;"
                                  Click="{x:Bind ViewModel.UnselectMessages}" />

            <controls:AnimatedTextBlock x:Name="ManageCount"
                                        Text="{x:Bind ConvertSelection(ViewModel.SelectedCount), Mode=OneWay}"
                                        TextStyle="{StaticResource BaseTextBlockStyle}"
                                        VerticalAlignment="Center"
                                        Margin="0,-2,0,0"
                                        Grid.Column="1" />

            <controls:GlyphButton x:Name="ButtonForward"
                                  Glyph="&#xE72D;"
                                  Content="{CustomResource Forward}"
                                  Click="{x:Bind ViewModel.ForwardSelectedMessages}"
                                  IsEnabled="{x:Bind ViewModel.CanForwardSelectedMessages, Mode=OneWay}"
                                  Style="{StaticResource GlyphButtonWithLabelStyle}"
                                  Grid.Column="3" />

            <controls:GlyphButton x:Name="ButtonDelete"
                                  Glyph="&#xE74D;"
                                  Content="{CustomResource Delete}"
                                  Foreground="{ThemeResource DangerButtonBackground}"
                                  Click="{x:Bind ViewModel.DeleteSelectedMessages}"
                                  IsEnabled="{x:Bind ViewModel.CanDeleteSelectedMessages, Mode=OneWay}"
                                  Style="{StaticResource GlyphButtonWithLabelStyle}"
                                  Grid.Column="4" />
        </Grid>

        <!--<Border x:Name="TextAreaBorder"
                BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                BorderThickness="1"
                Margin="12,0,12,8"
                CornerRadius="15"
                Grid.Row="3" />-->

        <chats:ChatSearchBar x:Name="SearchMask"
                             Visibility="Collapsed"
                             Grid.RowSpan="4"
                             Canvas.ZIndex="3" />

        <!--<controls:UndoView x:Name="Undo" VerticalAlignment="Bottom" Margin="0,0,0,-48" Grid.RowSpan="4"/>-->
    </Grid>
</controls:UserControlEx>
